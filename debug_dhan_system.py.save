# file: debug_dhan_system.py
import os, time, json, base64
import httpx

def decode_jwt(token: str):
    try:
        parts = token.split(".")
        if len(parts) != 3:
            return {"error": "invalid format"}
        payload = parts[1] + "=" * (-len(parts[1]) % 4)
        data = json.loads(base64.urlsafe_b64decode(payload))
        exp = data.get("exp")
        return {
            "exp_raw": exp,
            "exp_human": time.strftime("%Y-%m-%d %H:%M:%S", time.gmtime(exp)) if exp else None,
            "valid_now": (exp or 0) > time.time(),
        }
    except Exception as e:
        return {"error": str(e)}

def check_api(client_id, token):
    url = "https://api.dhan.co/v2/instruments/master"
    try:
        r = httpx.get(url, headers={"": client_id, "access-token": token}, timeout=15)
        return r.status_code, r.text[:200]
    except Exception as e:
        return 0, str(e)

def expirylist(client_id, token, security_id, seg):
    url = "https://api.dhan.co/v2/optionchain/expirylist"
    r = httpx.post(url,
        headers={"client-id": client_id, "access-token": token, "Content-Type":"application/json"},
        json={"UnderlyingScrip": security_id, "UnderlyingSeg": seg}, timeout=15)
    return r.status_code, r.json()

# ===== MAIN =====
mode = os.getenv("APP_MODE", "SANDBOX")
print(f"APP_MODE = {mode}")

if mode == "LIVE":
    cid, token = os.getenv("DHAN_LIVE_CLIENT_ID"), os.getenv("DHAN_LIVE_TOKEN")
else:
    cid, token = os.getenv("DHAN_SAND_CLIENT_ID"), os.getenv("DHAN_SAND_TOKEN")

print("Client ID:", cid)
print("Token length:", len(token) if token else "MISSING")
print("Token decode:", decode_jwt(token))

# Step 1: Master instrument API check
print("\n[1] Instrument Master check")
code, body = check_api(cid, token)
print("Status:", code, "Body:", body)

# Step 2: Expiry list check (NIFTY = 2, BANKNIFTY = 25, FINNIFTY = 26009, SENSEX = 301)
print("\n[2] Expirylist check (NIFTY)")
code, body = expirylist(cid, token, 2, "IDX_I")
print("Status:", code, "Body:", body)

print("\n[3] Expirylist check (FINNIFTY)")
code, body = expirylist(cid, token, 26009, "IDX_I")
print("Status:", code, "Body:", body)
```
