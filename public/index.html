<script>
/* =================== CONFIG =================== */
const RAW_BASE_URL = "https://options-analysis.onrender.com";                 // your backend
const DEFAULT_BASE_URL = RAW_BASE_URL.replace(/\/+$/, "");
const API_PRESETS = { prod: DEFAULT_BASE_URL, dev: "http://127.0.0.1:10000" };

// If you set a WEBHOOK SECRET on backend, put it here so AI endpoints work from browser.
// If backend has no secret, leave blank ("").
const WEBHOOK_SECRET = ""; // e.g. "my-secret" (optional)

(function resolveBaseUrl(){
  const q = new URLSearchParams(location.search);
  const pick = q.get("api");
  let chosen = pick ? (API_PRESETS[pick] || pick) : (localStorage.getItem("api_base")||"");
  if (pick) localStorage.setItem("api_base", chosen);
  window.BASE_URL = (chosen || DEFAULT_BASE_URL).replace(/\/+$/, "");
  console.log("[CFG] BASE_URL:", window.BASE_URL);
})();

/* =================== HTTP HELPERS =================== */
const withTimeout=(p,ms=15000)=>new Promise((res,rej)=>{const t=setTimeout(()=>rej(new Error("Timeout "+ms+"ms")),ms);p.then(v=>{clearTimeout(t);res(v)}).catch(e=>{clearTimeout(t);rej(e)})});
async function api(path,{method="GET",params=null,body=null,headers={}}={}) {
  const url=new URL(window.BASE_URL+path);
  if(params) for(const [k,v] of Object.entries(params)) url.searchParams.set(k,v);
  const opt={method,headers:{Accept:"application/json",...headers}};
  if (WEBHOOK_SECRET) opt.headers["X-Webhook-Secret"]=WEBHOOK_SECRET;
  if(body){opt.headers["Content-Type"]="application/json";opt.body=JSON.stringify(body);}
  const r=await withTimeout(fetch(url,opt), 20000);
  if (!r.ok) throw new Error("HTTP "+r.status+" "+r.statusText);
  return r.json();
}
const apiGet=(p,params)=>api(p,{method:"GET",params});
const apiPost=(p,body)=>api(p,{method:"POST",body});

/* =================== SMALL UTILS =================== */
const byId = id => document.getElementById(id);
const fmt  = n => (n===null||n===undefined||isNaN(+n)) ? "—" : (+n).toLocaleString("en-IN");

/* =================== STATUS / SELFTEST =================== */
async function initStatus(){
  try{
    const st = await apiGet("/__selftest");
    const info = st?.status || {};
    const tokenOk = !!info.status?.token_present;
    const cliOk   = !!info.status?.client_id_present;

    byId("br_conn")?.classList.add((tokenOk&&cliOk)?"text-bg-success":"text-bg-warning");
    if (byId("br_conn")) byId("br_conn").textContent = (tokenOk&&cliOk) ? "Connected" : "Partial";

    if (byId("br_token")) { byId("br_token").className="badge "+(tokenOk?"text-bg-success":"text-bg-danger"); byId("br_token").textContent=tokenOk?"present":"missing";}
    if (byId("br_client")){ byId("br_client").className="badge "+(cliOk?"text-bg-success":"text-bg-danger"); byId("br_client").textContent=cliOk?"present":"missing";}
  }catch(e){
    console.error(e);
    if (byId("br_conn")) { byId("br_conn").className="badge text-bg-danger"; byId("br_conn").textContent="Backend error"; }
  }
}

/* =================== INSTRUMENTS (optional search) =================== */
/* Example use:
   const matches = await searchInstruments("NIFTY","IDX_I"); */
async function searchInstruments(q, exchange_segment){
  const j = await apiGet("/instruments/search",{ q, exchange_segment });
  return j?.data || [];
}

/* =================== EXPIRIES + CHAIN =================== */
async function loadExpiries(){
  const [under_security_id, under_exchange_segment, label] = byId("symbolSelect").value.split("|");
  if (byId("oc_title")) byId("oc_title").textContent = `Option Chain — ${label}`;
  const j = await apiGet("/optionchain/expirylist", { under_security_id, under_exchange_segment });
  const list = (j?.data?.data) || j?.data || [];
  const sel = byId("expirySelect"); if (!sel) return;
  sel.innerHTML="";
  (list||[]).forEach(x => { const o=document.createElement("option"); o.value=x; o.textContent=x; sel.appendChild(o); });
}

async function fetchChain(){
  const [under_security_id, under_exchange_segment] = byId("symbolSelect").value.split("|");
  const expiry = byId("expirySelect")?.value; if (!expiry) return;
  const res = await apiPost("/optionchain", { under_security_id:+under_security_id, under_exchange_segment, expiry });
  const raw = res?.data?.data || res?.data || {};
  renderOptionChain(raw);
}

function renderOptionChain(raw){
  const strikes = Object.keys(raw).map(k=>+k).sort((a,b)=>a-b);
  const win = +byId("strikeWin")?.value || 10;
  const tbody = byId("oc_body"); if (!tbody) return;
  tbody.innerHTML="";

  const ceOiTop=[], peOiTop=[], ceVol=[], peVol=[];
  const mid = strikes[Math.floor(strikes.length/2)] || 0;
  const minS = mid - win*50, maxS = mid + win*50;

  strikes.forEach(sp=>{
    if (sp<minS || sp>maxS) return;
    const d=raw[sp]||{}, CE=d.CE||d.ce||{}, PE=d.PE||d.pe||{};
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td class="call">${fmt(CE.oi)}</td>
      <td class="call">${fmt(CE.previous_oi!=null ? (CE.oi-CE.previous_oi) : null)}</td>
      <td class="call">${fmt(CE.volume)}</td>
      <td class="call">${CE.implied_volatility!=null ? (+CE.implied_volatility).toFixed(2) : "—"}</td>
      <td class="call">${CE.last_price!=null ? "₹"+(+CE.last_price).toFixed(2) : "—"}</td>
      <td class="call">${CE.change!=null ? (+CE.change).toFixed(2) : "—"}</td>
      <td class="text-center fw-semibold">${fmt(sp)}</td>
      <td class="put">${PE.change!=null ? (+PE.change).toFixed(2) : "—"}</td>
      <td class="put">${PE.last_price!=null ? "₹"+(+PE.last_price).toFixed(2) : "—"}</td>
      <td class="put">${PE.implied_volatility!=null ? (+PE.implied_volatility).toFixed(2) : "—"}</td>
      <td class="put">${fmt(PE.volume)}</td>
      <td class="put">${fmt(PE.previous_oi!=null ? (PE.oi-PE.previous_oi) : null)}</td>
      <td class="put">${fmt(PE.oi)}</td>`;
    tbody.appendChild(tr);

    ceOiTop.push({sp, v:+CE.oi||0}); peOiTop.push({sp, v:+PE.oi||0});
    ceVol.push({sp, v:+CE.volume||0}); peVol.push({sp, v:+PE.volume||0});
  });

  // charts
  const topN=(arr,n=10)=>arr.sort((a,b)=>b.v-a.v).slice(0,n).sort((a,b)=>a.sp-b.sp);
  const topCe=topN(ceOiTop), topPe=topN(peOiTop);
  const topCeV=topN(ceVol),  topPeV=topN(peVol);
  drawBar("oiChart","OI",
    topCe.map(x=>x.sp).concat(topPe.map(x=>x.sp)),
    topCe.map(x=>x.v).concat(topPe.map(x=>x.v))
  );
  drawBar("volChart","Volume",
    topCeV.map(x=>x.sp).concat(topPeV.map(x=>x.sp)),
    topCeV.map(x=>x.v).concat(topPeV.map(x=>x.v))
  );
}

/* =================== LTP & SMALL STATS =================== */
async function loadSpot(){
  // demo: HDFCBANK equity 1333 on NSE
  const res = await apiGet("/marketfeed/ltp",{exchange_segment:"NSE_EQ",security_id:1333});
  const ltp = res?.data?.ltp ?? res?.data ?? null;
  if (byId("spotPrice")) byId("spotPrice").textContent = (ltp!=null) ? "₹"+(+ltp).toFixed(2) : "—";
  // placeholder stats (replace later with real calc if needed)
  if (byId("oiChange")) byId("oiChange").textContent = (Math.random()>0.5?"+":"-")+(Math.random()*2).toFixed(1)+"%";
  if (byId("pcrValue")) byId("pcrValue").textContent = (0.7+Math.random()*0.3).toFixed(2);
  if (byId("ivValue"))  byId("ivValue").textContent  = (16+Math.random()*3).toFixed(1)+"%";
}

/* =================== CHARTS =================== */
let oiChart, volChart;
function drawBar(el, label, labels, data){
  const canvas = byId(el); if (!canvas) return;
  const ctx = canvas.getContext("2d");
  if (el==="oiChart" && oiChart) oiChart.destroy();
  if (el==="volChart" && volChart) volChart.destroy();
  const inst = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label, data }] },
    options:{ plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:"#9aa1aa"}},y:{ticks:{color:"#9aa1aa"}}}}
  });
  if (el==="oiChart") oiChart=inst; else volChart=inst;
}

/* =================== AI BUTTONS =================== */
function wireAI(){
  byId("btn_ai_market")?.addEventListener("click", async ()=>{
    const [under_security_id, under_exchange_segment] = byId("symbolSelect").value.split("|");
    const j = await apiPost("/ai/marketview",{under_security_id:+under_security_id, under_exchange_segment});
    byId("ai_market_out").textContent = (j?.ai_reply||JSON.stringify(j,null,2));
  });
  byId("btn_ai_payoff")?.addEventListener("click", async ()=>{
    const [under_security_id, under_exchange_segment] = byId("symbolSelect").value.split("|");
    const j = await apiPost("/ai/payoff",{under_security_id:+under_security_id, under_exchange_segment});
    byId("ai_payoff_out").textContent = (j?.ai_payoff||JSON.stringify(j,null,2));
  });
  byId("btn_ai_strategy")?.addEventListener("click", async ()=>{
    const [under_security_id, under_exchange_segment] = byId("symbolSelect").value.split("|");
    const bias = byId("sb_bias")?.value || "neutral";
    const risk = byId("sb_risk")?.value || "moderate";
    const capital = +(byId("sb_cap")?.value || 50000);
    const j = await apiPost("/ai/strategy",{under_security_id:+under_security_id, under_exchange_segment, bias, risk, capital});
    byId("sb_out").textContent = (j?.ai_strategy||JSON.stringify(j,null,2));
  });
}

/* =================== AUTOREFRESH =================== */
let timer=null;
function setAuto(){
  if (timer){ clearInterval(timer); timer=null; }
  if (byId("autoToggle")?.checked){
    timer=setInterval(()=>{ fetchChain().catch(console.error); loadSpot().catch(console.error); }, 30000);
  }
}

/* =================== EVENTS / BOOT =================== */
byId("symbolSelect")?.addEventListener("change", ()=> loadExpiries().then(fetchChain).catch(console.error));
byId("btn_fetch")?.addEventListener("click", ()=> fetchChain().catch(console.error));
byId("btn_clear")?.addEventListener("click", ()=> { byId("oc_body").innerHTML=`<tr><td colspan="13" class="text-center text-secondary py-4">Cleared</td></tr>`; });
byId("btn_refresh")?.addEventListener("click", ()=> { initStatus(); loadExpiries().then(fetchChain); loadSpot(); });
byId("autoToggle")?.addEventListener("change", setAuto);

(async function boot(){
  await initStatus();
  try{ await loadExpiries(); }catch(e){ console.warn("expiry load failed", e); }
  try{ await fetchChain(); }catch(e){ console.warn("chain fetch failed", e); }
  try{ await loadSpot(); }catch(e){ console.warn("spot failed", e); }
  wireAI();
  setAuto();
})();
</script>
