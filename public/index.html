<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Options Strategy Builder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    :root{ --bg:#0f172a;--card:#111827;--muted:#94a3b8;--accent:#3b82f6;--ok:#10b981;--bad:#ef4444;}
    body{background:#0b1220;color:#e5e7eb}
    .hero{background:linear-gradient(135deg,#111827,#0f172a);}
    .chip{background:#0f172a;border:1px solid #1f2937;color:#cbd5e1;border-radius:999px;padding:.25rem .6rem;font-size:.8rem}
    .card{background:#0f172a;border:1px solid #1f2937}
    .card-header{background:#0f172a;border-bottom:1px solid #1f2937}
    .stat .label{color:#94a3b8;font-size:.8rem}
    .stat .value{font-weight:700;font-size:1.25rem}
    .badge-dot{display:inline-flex;align-items:center;gap:.4rem}
    .dot{width:.55rem;height:.55rem;border-radius:50%}
    .table thead th{position:sticky;top:0;background:#0f172a;border-bottom:1px solid #1f2937}
    .call{background:rgba(16,185,129,.08)}
    .put{background:rgba(239,68,68,.08)}
    a.btn-icon{border:1px solid #1f2937}
    .nav-tabs .nav-link{color:#9fb0c7}
    .nav-tabs .nav-link.active{color:#fff;background:transparent;border-bottom:2px solid var(--accent)}
    .hl{color:#93c5fd}
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="hero py-3 border-bottom border-secondary-subtle">
    <div class="container d-flex flex-wrap align-items-center justify-content-between gap-3">
      <div>
        <h4 class="m-0">AI Options Strategy Builder</h4>
        <div class="mt-2 d-flex flex-wrap gap-2">
          <span id="chip_dhan" class="chip"><i class="bi bi-boxes me-1"></i>Dhan v2</span>
          <span id="chip_env" class="chip"><i class="bi bi-cloud me-1"></i>—</span>
          <span id="chip_mode" class="chip"><i class="bi bi-sliders me-1"></i>—</span>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="market_flag" class="badge-dot">
          <span class="dot" style="background:var(--ok)"></span><span>Market Open</span>
        </span>
        <a id="btn_refresh" class="btn btn-sm btn-light btn-icon" title="Refresh"><i class="bi bi-arrow-clockwise"></i></a>
        <a class="btn btn-sm btn-light btn-icon" href="?api=prod" title="Use PROD"><i class="bi bi-cloud-check"></i></a>
        <a class="btn btn-sm btn-light btn-icon" href="?api=dev" title="Use Local DEV"><i class="bi bi-pc-display"></i></a>
      </div>
    </div>
  </div>

  <div class="container py-3">
    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#home" type="button">Dashboard</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#strategy" type="button">Strategy Builder</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#expiry" type="button">Expiry Analysis</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ai" type="button">AI Recommendations</button></li>
    </ul>

    <div class="tab-content">
      <!-- DASHBOARD -->
      <div class="tab-pane fade show active" id="home">
        <!-- Controls + Broker -->
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Controls</span>
                <div class="d-flex align-items-center gap-2">
                  <button id="btn_fetch" class="btn btn-primary btn-sm"><i class="bi bi-lightning-charge"></i> Fetch Option Chain</button>
                  <button id="btn_clear" class="btn btn-outline-light btn-sm">Clear</button>
                </div>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Symbol</label>
                    <select id="symbolSelect" class="form-select">
                      <option value="13|IDX_I|NIFTY">NIFTY</option>
                      <option value="25|IDX_I|BANKNIFTY" selected>BANKNIFTY</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Expiry</label>
                    <select id="expirySelect" class="form-select"><option value="">Loading…</option></select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Strikes window</label>
                    <select id="strikeWin" class="form-select">
                      <option value="10" selected>±10</option>
                      <option value="20">±20</option>
                      <option value="30">±30</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-header">Broker Status</div>
              <div class="card-body">
                <div class="d-flex flex-column gap-2">
                  <div class="d-flex justify-content-between"><span class="text-secondary">Connection</span><span id="br_conn" class="badge text-bg-success">Connected</span></div>
                  <div class="d-flex justify-content-between"><span class="text-secondary">Token</span><span id="br_token" class="badge text-bg-secondary">—</span></div>
                  <div class="d-flex justify-content-between"><span class="text-secondary">Client ID</span><span id="br_client" class="badge text-bg-secondary">—</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div class="row g-4 mt-1">
          <div class="col-md-3"><div class="card stat"><div class="card-body"><div class="label">Spot (demo: HDFCBANK)</div><div id="spotPrice" class="value">—</div></div></div></div>
          <div class="col-md-3"><div class="card stat"><div class="card-body"><div class="label">OI Change</div><div id="oiChange" class="value">—</div></div></div></div>
          <div class="col-md-3"><div class="card stat"><div class="card-body"><div class="label">Put/Call Ratio</div><div id="pcrValue" class="value">—</div></div></div></div>
          <div class="col-md-3"><div class="card stat"><div class="card-body"><div class="label">Avg. IV</div><div id="ivValue" class="value">—</div></div></div></div>
        </div>

        <!-- Charts -->
        <div class="row g-4 mt-1">
          <div class="col-lg-6"><div class="card"><div class="card-header">Open Interest (Top Strikes)</div><div class="card-body"><canvas id="oiChart" height="220"></canvas></div></div></div>
          <div class="col-lg-6"><div class="card"><div class="card-header">Volume (Top Strikes)</div><div class="card-body"><canvas id="volChart" height="220"></canvas></div></div></div>
        </div>

        <!-- Option Chain Table -->
        <div class="card mt-4">
          <div class="card
