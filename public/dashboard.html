<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Options Analysis Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b1220;color:#e6eefc}
    header{padding:16px 20px;border-bottom:1px solid #1b2740;display:flex;gap:12px;align-items:center}
    main{padding:20px;max-width:1100px;margin:0 auto}
    .card{background:#121a2b;border:1px solid #1b2740;border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .k{opacity:.7}
    .ok{color:#8ee59d}.bad{color:#ff8c8c}.neu{color:#b7c2d1}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #233353;background:#0f1626}
    button,select{background:#16233d;color:#e6eefc;border:1px solid #2b3f66;border-radius:10px;padding:8px 12px}
    .small{font-size:12px;opacity:.7}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
<header>
  <strong>ðŸš€ Options Analysis</strong>
  <select id="symbol">
    <option>NIFTY</option>
    <option>BANKNIFTY</option>
  </select>
  <label class="small"><input id="live" type="checkbox"> live</label>
  <button id="refresh">Refresh</button>
  <span id="status" class="small pill">idle</span>
</header>

<main>
  <div class="row">
    <div class="card">
      <h3>Snapshot</h3>
      <div id="snapMeta" class="small k"></div>
      <pre id="snapshotBox" class="small"></pre>
    </div>
    <div class="card">
      <h3>Fusion</h3>
      <div id="fusionVerdict" class="pill"></div>
      <div id="fusionDetails" class="small k" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card">
    <h3>Blades</h3>
    <div id="blades"></div>
  </div>
</main>

<script>
const $ = (id)=>document.getElementById(id);
const cls = (sig)=> sig==='bullish'?'ok':(sig==='bearish'?'bad':'neu');

async function fetchSnapshot(sym, live){
  const url = `/data/snapshot?symbol=${encodeURIComponent(sym)}${live?'&live=true':''}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

async function analyze(inputs){
  const body = {
    min_confirms: 3,
    weights: { price:1, oi:1, greeks:0.8, volume:0.7, sentiment:0.5 },
    inputs
  };
  const r = await fetch('/sudarshan/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function bladeRow(name, data){
  return `<div style="margin:6px 0">
    <span class="pill ${cls(data.signal)}">${name}: ${data.signal}</span>
    <span class="small k"> ${JSON.stringify(data.detail)}</span>
  </div>`;
}

async function run(){
  const sym = $('symbol').value;
  const live = $('live').checked;
  $('status').textContent = 'loadingâ€¦';
  try{
    const snap = await fetchSnapshot(sym, live);
    $('snapMeta').textContent = `${snap.symbol} â€¢ live=${live}`;
    $('snapshotBox').textContent = JSON.stringify(snap.sudarshan_inputs,null,2);

    const res = await analyze(snap.sudarshan_inputs);
    const f = res.fusion || {};
    $('fusionVerdict').textContent = `verdict: ${f.verdict||'n/a'}`;
    $('fusionVerdict').className = `pill ${cls(f.verdict||'neutral')}`;
    $('fusionDetails').textContent = `score=${f.score} â€¢ confirms=${f.confirms}/${f.min_needed}`;

    const pb = res.per_blade || {};
    $('blades').innerHTML = Object.entries(pb).map(([k,v])=>bladeRow(k,v)).join('');
    $('status').textContent = 'ok';
  }catch(e){
    $('status').textContent = 'error';
    alert(e.message);
  }
}

$('refresh').onclick = run;
setInterval(()=>{ if(document.visibilityState==='visible') run(); }, 10000);
run();
</script>
</body>
</html>
