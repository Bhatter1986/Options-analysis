<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Options Analysis Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0e1621;
      --panel: #121c27;
      --panel-2: #0f1a24;
      --text: #e8eef4;
      --muted: #9bb0c2;
      --ok: #18c36e;
      --err: #ff6b6b;
      --chip: #203040;
      --chip-txt: #b4c6d8;
      --accent: #2dd4bf;
      --table-border: #223447;
      --hl: #1f3a5a;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .titlebar { display:flex; align-items:center; gap:12px; justify-content: space-between; }
    h1 { font-weight:700; font-size: 20px; margin: 0; }
    .controls { display:flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .control { background: var(--panel); border: 1px solid #1b2a3a; border-radius: 10px; padding: 10px; display:flex; align-items:center; gap:8px; }
    .control label { color: var(--muted); font-size: 12px; }
    select, input[type="number"] { background: var(--panel-2); color: var(--text); border:1px solid #1c2b3b; border-radius: 8px; padding: 8px 10px; }
    button { background: var(--accent); color:#062028; border:none; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .pill { padding:6px 10px; border-radius: 999px; background:var(--chip); color:var(--chip-txt); font-size:12px; display:inline-flex; gap:6px; align-items:center; }
    .badge { padding:6px 10px; border-radius: 999px; font-size:12px; }
    .badge-ok { background: #153e31; color:#8ff5c8; border:1px solid #1f6a53; }
    .badge-err { background:#3a1a1a; color:#ffc9c9; border:1px solid #6b2b2b; }
    .panel { margin-top:14px; background:var(--panel); border:1px solid #1b2a3a; border-radius:14px; }
    .panel-hd { padding:14px 16px; display:flex; align-items:center; justify-content: space-between; border-bottom:1px solid #1b2a3a; }
    .panel-ttl { font-weight:600; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; text-align:right; border-bottom:1px solid var(--table-border); }
    th:first-child, td:first-child { text-align:left; }
    tr.atm { background: rgba(45, 212, 191, 0.08); }
    .muted { color: var(--muted); }
    .note { padding: 18px; color: var(--muted); text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="titlebar">
      <h1>Options Analysis Dashboard</h1>
      <div id="statusBadge" class="badge badge-ok">OK</div>
    </div>

    <div class="controls" style="margin-top:12px">
      <div class="control">
        <label>Instrument</label>
        <select id="instrument">
          <!-- You can add more later; keeping BankNifty (IDX_I) stable for now -->
          <option value="25|IDX_I" selected>BANKNIFTY (ID)</option>
        </select>
      </div>

      <div class="control">
        <label>Expiry</label>
        <select id="expiry"></select>
      </div>

      <div class="control">
        <label>Window (±)</label>
        <input id="win" type="number" value="15" min="1" max="50" />
      </div>

      <div class="control">
        <label>Show full chain</label>
        <input id="full" type="checkbox" />
      </div>

      <button id="refresh">Refresh</button>
    </div>

    <div class="panel">
      <div class="panel-hd">
        <div class="panel-ttl">Options Chain</div>
        <div class="muted" id="stamp">Updated —</div>
      </div>

      <div style="padding:10px 16px; display:flex; gap:8px; flex-wrap:wrap;">
        <span class="pill">LTP: <b id="ltp">—</b></span>
        <span class="pill">PCR: <b id="pcr">—</b></span>
        <span class="pill">Max Pain: <b id="mp">—</b></span>
        <span class="pill">rows: <b id="rows">—</b></span>
      </div>

      <div id="tableWrap">
        <table id="chainTbl">
          <thead>
            <tr>
              <th>CE LTP</th>
              <th>CE IV</th>
              <th>CE OI</th>
              <th>Δ OI</th>
              <th>STRIKE</th>
              <th>Δ OI</th>
              <th>PE OI</th>
              <th>PE IV</th>
              <th>PE LTP</th>
            </tr>
          </thead>
          <tbody id="chainBody">
            <tr><td class="note" colspan="9">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="note">Tip: ATM row is highlighted. Use “Show full chain” for all strikes.</div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const instrumentEl = $('#instrument');
    const expiryEl     = $('#expiry');
    const winEl        = $('#win');
    const fullEl       = $('#full');
    const refreshBtn   = $('#refresh');
    const badge        = $('#statusBadge');

    const el = {
      ltp: $('#ltp'), pcr: $('#pcr'), mp: $('#mp'), rows: $('#rows'),
      body: $('#chainBody'), stamp: $('#stamp')
    };

    const state = {
      underId: 25,
      segment: 'IDX_I',
      expiry: null,
      step: 100,     // BankNifty
    };

    function setBadgeOk(msg='OK')  { badge.className='badge badge-ok';  badge.textContent=msg; }
    function setBadgeErr(msg='Error') { badge.className='badge badge-err'; badge.textContent=msg; }

    function parseInstrument(value) {
      const [id, seg] = value.split('|');
      state.underId = Number(id);
      state.segment = seg;
      // simple step rule
      state.step = (state.underId === 25 ? 100 : 50);
    }

    async function fetchJson(url) {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    async function loadExpiries() {
      try {
        const url = `/optionchain/expirylist?under_security_id=${state.underId}&under_exchange_segment=${state.segment}`;
        const j = await fetchJson(url);
        const list = (j && j.status === 'success' && Array.isArray(j.data)) ? j.data : [];
        expiryEl.innerHTML = '';
        if (list.length === 0) {
          state.expiry = null;
          const opt = document.createElement('option');
          opt.textContent = 'No expiries';
          opt.value = '';
          expiryEl.appendChild(opt);
          setBadgeErr('No expiries');
          return;
        }
        // Fill dropdown
        for (const d of list) {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          expiryEl.appendChild(opt);
        }
        // Auto-pick first valid expiry
        state.expiry = list[0];
        expiryEl.value = state.expiry;
        console.log('Using expiry:', state.expiry);
        setBadgeOk('OK');
      } catch (e) {
        console.error('expiry error', e);
        setBadgeErr('expiry error');
        expiryEl.innerHTML = `<option value="">Error</option>`;
        state.expiry = null;
      }
    }

    function renderRows(rows, spot) {
      el.body.innerHTML = '';
      if (!rows || rows.length === 0) {
        el.body.innerHTML = `<tr><td class="note" colspan="9">No data</td></tr>`;
        return;
      }
      // find ATM by closest strike to spot
      let atmIndex = -1;
      if (spot) {
        let best = Number.MAX_VALUE;
        rows.forEach((r, i) => {
          const d = Math.abs(r.strike - spot);
          if (d < best) { best = d; atmIndex = i; }
        });
      }
      for (let i=0; i<rows.length; i++) {
        const r = rows[i];
        const tr = document.createElement('tr');
        if (i === atmIndex) tr.classList.add('atm');

        const fmt = (x, digits=2) => (typeof x === 'number' && isFinite(x)) ? x.toFixed(digits) : '0';
        const int = (x) => (typeof x === 'number' && isFinite(x)) ? x.toLocaleString() : '0';

        tr.innerHTML = `
          <td>${fmt(r.call.price)}</td>
          <td>${fmt(r.call.iv)}</td>
          <td>${int(r.call.oi)}</td>
          <td>${int(r.call.chgOi)}</td>
          <td style="font-weight:600">${r.strike.toLocaleString()}</td>
          <td>${int(r.put.chgOi)}</td>
          <td>${int(r.put.oi)}</td>
          <td>${fmt(r.put.iv)}</td>
          <td>${fmt(r.put.price)}</td>
        `;
        el.body.appendChild(tr);
      }
    }

    async function loadChain() {
      try {
        if (!state.expiry) {
          await loadExpiries(); // ensure we have one
          if (!state.expiry) return;
        }
        const showAll = fullEl.checked ? 'true' : 'false';
        const win = Number(winEl.value || 15);
        const url = `/optionchain?under_security_id=${state.underId}&under_exchange_segment=${state.segment}&expiry=${encodeURIComponent(state.expiry)}&show_all=${showAll}&strikes_window=${win}&step=${state.step}`;

        const j = await fetchJson(url);
        if (j.status !== 'success') throw new Error('API status failed');

        // Top stats
        el.ltp.textContent  = (j.spot ?? 0).toFixed(2);
        el.pcr.textContent  = j.summary?.pcr ?? '0.00';
        el.mp.textContent   = j.summary?.max_pain ?? '—';
        el.rows.textContent = j.meta?.count_window ?? '0';
        el.stamp.textContent = `Updated — ${new Date().toLocaleTimeString()}`;

        renderRows(j.chain || [], j.spot || 0);
        setBadgeOk('OK');
      } catch (e) {
        console.error('chain error', e);
        setBadgeErr('chain error');
        el.body.innerHTML = `<tr><td class="note" colspan="9">Error loading chain</td></tr>`;
      }
    }

    // Events
    instrumentEl.addEventListener('change', async () => {
      parseInstrument(instrumentEl.value);
      await loadExpiries();
      loadChain();
    });
    expiryEl.addEventListener('change', () => {
      state.expiry = expiryEl.value || null;
      loadChain();
    });
    winEl.addEventListener('change', loadChain);
    fullEl.addEventListener('change', loadChain);
    refreshBtn.addEventListener('click', async () => {
      if (!state.expiry) await loadExpiries();
      loadChain();
    });

    // Init
    (async function init() {
      parseInstrument(instrumentEl.value);
      await loadExpiries();   // <-- makes sure expiry is always valid
      loadChain();
    })();
  </script>
</body>
</html>
