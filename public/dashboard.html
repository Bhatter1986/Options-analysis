<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Analysis Dashboard with Dhan API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #e6e6e6;
            padding-top: 20px;
        }
        
        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #2d3047;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            color: #e6e6e6;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .market-index {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .index-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .index-change {
            font-size: 1rem;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .positive {
            color: #2ecc71;
        }
        
        .negative {
            color: #e74c3c;
        }
        
        .btn-primary {
            background: var(--secondary-color);
            border: none;
        }
        
        .btn-primary:hover {
            background: var(--primary-color);
        }
        
        .table-dark {
            background: #2d3047;
            color: #e6e6e6;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.2);
            color: #fff;
        }
        
        .sudarshan-chakra {
            width: 100%;
            height: 300px;
            background: conic-gradient(
                from 0deg,
                #2ecc71 0% 10%,
                #3498db 10% 20%,
                #9b59b6 20% 30%,
                #e74c3c 30% 40%,
                #f39c12 40% 50%,
                #1abc9c 50% 60%,
                #34495e 60% 70%,
                #e67e22 70% 80%,
                #16a085 80% 90%,
                #8e44ad 90% 100%
            );
            border-radius: 50%;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.5);
        }
        
        .chakra-center {
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        
        .tradingview-widget {
            width: 100%;
            height: 400px;
            background: #2d3047;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e6e6e6;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .expiry-selector {
            background: #2d3047;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .ai-analysis {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .section-title {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .strike-price {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .call-oi {
            color: #2ecc71;
        }
        
        .put-oi {
            color: #e74c3c;
        }
        
        .highlight {
            background: rgba(52, 152, 219, 0.3) !important;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .api-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .status-connected {
            background: rgba(46, 204, 113, 0.2);
            border-left: 4px solid #2ecc71;
        }
        
        .status-disconnected {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-chart-line me-2"></i>
                    Advanced Options Analysis Dashboard
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#"><i class="fas fa-home"></i> Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-bell"></i> Alerts</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-cog"></i> Settings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#"><i class="fas fa-user"></i> Login</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="row">
            <!-- Left Sidebar -->
            <div class="col-lg-3">
                <!-- API Connection Status -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-plug me-2"></i>API Connections
                    </div>
                    <div class="card-body">
                        <div class="api-status status-connected">
                            <span>Dhan API:</span>
                            <span class="badge bg-success">Connected</span>
                        </div>
                        <div class="api-status status-connected">
                            <span>OpenAI API:</span>
                            <span class="badge bg-success">Connected</span>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-light" onclick="fetchMarketData()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Market Indices -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-bar me-2"></i>Market Indices
                    </div>
                    <div class="card-body">
                        <div class="market-index">
                            <h5>NIFTY 50</h5>
                            <div class="index-value" id="nifty-value">Loading...</div>
                            <div class="index-change positive" id="nifty-change">+0.0%</div>
                            <div class="index-volume">Volume: <span id="nifty-volume">Loading...</span></div>
                        </div>
                        <div class="market-index" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                            <h5>BANKNIFTY</h5>
                            <div class="index-value" id="banknifty-value">Loading...</div>
                            <div class="index-change positive" id="banknifty-change">+0.0%</div>
                            <div class="index-volume">Volume: <span id="banknifty-volume">Loading...</span></div>
                        </div>
                    </div>
                </div>

                <!-- Expiry Selector -->
                <div class="expiry-selector">
                    <h5 class="section-title"><i class="fas fa-calendar-alt me-2"></i>Select Expiry</h5>
                    <div class="list-group" id="expiry-list">
                        <div class="loader"></div>
                    </div>
                </div>

                <!-- AI Analysis -->
                <div class="ai-analysis">
                    <h5 class="section-title"><i class="fas fa-robot me-2"></i>AI Analysis</h5>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>Market Outlook: <span id="ai-outlook">Loading...</span></h6>
                        <p id="ai-analysis-text">Analyzing market data...</p>
                    </div>
                    <button class="btn btn-light w-100" onclick="generateAIAnalysis()">
                        <i class="fas fa-brain me-2"></i>Generate Analysis
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-6">
                <!-- TradingView Widget -->
                <div class="tradingview-widget">
                    <div class="text-center">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h4>TradingView Chart</h4>
                        <p>NIFTY 50 - Real-time Chart</p>
                        <button class="btn btn-primary mt-2" onclick="loadTradingView()">Load Chart</button>
                    </div>
                </div>

                <!-- Options Chain -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-link me-2"></i>NIFTY Options Chain - <span id="current-expiry">Loading...</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>CALLS</th>
                                        <th>OI</th>
                                        <th>CHNG OI</th>
                                        <th>IV</th>
                                        <th class="strike-price">STRIKE</th>
                                        <th>IV</th>
                                        <th>CHNG OI</th>
                                        <th>OI</th>
                                        <th>PUTS</th>
                                    </tr>
                                </thead>
                                <tbody id="options-chain-body">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="loader"></div>
                                            <p>Loading options chain data...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="col-lg-3">
                <!-- Sudarshan Chakra -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-dharmachakra me-2"></i>Sudarshan Chakra
                    </div>
                    <div class="card-body text-center">
                        <div class="sudarshan-chakra">
                            <div class="chakra-center">NIFTY</div>
                        </div>
                        <p class="mt-3">Options Risk Visualization</p>
                        <div class="row mt-3">
                            <div class="col-6">
                                <div class="alert alert-success p-2">
                                    <small>Calls: <span id="call-percentage">0%</span></small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="alert alert-danger p-2">
                                    <small>Puts: <span id="put-percentage">0%</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Open Interest Analysis -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie me-2"></i>Open Interest Analysis
                    </div>
                    <div class="card-body">
                        <canvas id="oiChart" height="200"></canvas>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <span>Max Pain: <strong id="max-pain">Loading...</strong></span>
                                <span>PCR: <strong id="pcr-value">0.00</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dhan API Connection -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-database me-2"></i>Dhan API Data
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Last Update:</span>
                            <span id="last-update">12:45:23 PM</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Total OI:</span>
                            <span id="total-oi">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Total Volume:</span>
                            <span id="total-volume">0</span>
                        </div>
                        <button class="btn btn-outline-primary w-100" onclick="fetchOptionChain()">
                            <i class="fas fa-download me-2"></i>Fetch Latest Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentExpiry = '';
        let oiChart = null;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        // Initialize dashboard data
        function initializeDashboard() {
            fetchMarketData();
            fetchExpiryDates();
            fetchOptionChain();
        }

        // Fetch market data from Dhan API
        async function fetchMarketData() {
            try {
                // Show loading states
                document.getElementById('nifty-value').innerHTML = '<div class="loader sm"></div>';
                document.getElementById('banknifty-value').innerHTML = '<div class="loader sm"></div>';
                
                const response = await fetch('/api/market-data');
                const data = await response.json();
                
                // Update NIFTY data
                document.getElementById('nifty-value').textContent = data.nifty.value.toFixed(2);
                document.getElementById('nifty-change').textContent = `${data.nifty.change >= 0 ? '+' : ''}${data.nifty.change.toFixed(2)}%`;
                document.getElementById('nifty-change').className = `index-change ${data.nifty.change >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('nifty-volume').textContent = `${(data.nifty.volume / 1000000).toFixed(1)}M`;
                
                // Update BANKNIFTY data
                document.getElementById('banknifty-value').textContent = data.banknifty.value.toFixed(2);
                document.getElementById('banknifty-change').textContent = `${data.banknifty.change >= 0 ? '+' : ''}${data.banknifty.change.toFixed(2)}%`;
                document.getElementById('banknifty-change').className = `index-change ${data.banknifty.change >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('banknifty-volume').textContent = `${(data.banknifty.volume / 1000000).toFixed(1)}M`;
                
                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching market data:', error);
                alert('Failed to fetch market data. Please try again.');
            }
        }

        // Fetch expiry dates from Dhan API
        async function fetchExpiryDates() {
            try {
                const response = await fetch('/api/expiry-dates');
                const expiryDates = await response.json();
                
                const expiryList = document.getElementById('expiry-list');
                expiryList.innerHTML = '';
                
                expiryDates.forEach((date, index) => {
                    const isActive = index === 0;
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = `list-group-item list-group-item-action ${isActive ? 'active' : ''}`;
                    item.textContent = new Date(date).toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                    item.onclick = () => selectExpiry(date);
                    
                    expiryList.appendChild(item);
                });
                
                // Select first expiry by default
                if (expiryDates.length > 0) {
                    selectExpiry(expiryDates[0]);
                }
            } catch (error) {
                console.error('Error fetching expiry dates:', error);
            }
        }

        // Select expiry date
        function selectExpiry(expiry) {
            currentExpiry = expiry;
            document.getElementById('current-expiry').textContent = new Date(expiry).toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            
            // Update active class in expiry list
            const items = document.querySelectorAll('#expiry-list a');
            items.forEach(item => {
                if (item.textContent === new Date(expiry).toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                })) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Fetch option chain for selected expiry
            fetchOptionChain();
        }

        // Fetch option chain data from Dhan API
        async function fetchOptionChain() {
            try {
                // Show loading state
                document.getElementById('options-chain-body').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center">
                            <div class="loader"></div>
                            <p>Loading options chain data...</p>
                        </td>
                    </tr>
                `;
                
                const response = await fetch(`/api/option-chain?expiry=${encodeURIComponent(currentExpiry)}`);
                const chainData = await response.json();
                
                renderOptionChain(chainData);
                updateOIAnalysis(chainData);
                updateSudarshanChakra(chainData);
                
                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error fetching option chain:', error);
                alert('Failed to fetch option chain data. Please try again.');
            }
        }

        // Render option chain table
        function renderOptionChain(chainData) {
            const tbody = document.getElementById('options-chain-body');
            tbody.innerHTML = '';
            
            chainData.forEach(option => {
                const row = document.createElement('tr');
                
                // Highlight ATM strike (closest to current price)
                const niftyValue = parseFloat(document.getElementById('nifty-value').textContent);
                if (Math.abs(option.strike - niftyValue) <= 50) {
                    row.classList.add('highlight');
                }
                
                row.innerHTML = `
                    <td>${option.call.price || '0.00'}</td>
                    <td class="call-oi">${option.call.oi ? option.call.oi.toLocaleString() : '0'}</td>
                    <td class="${option.call.changeOi >= 0 ? 'positive' : 'negative'}">${option.call.changeOi >= 0 ? '+' : ''}${option.call.changeOi || '0'}</td>
                    <td>${option.call.iv || '0.0%'}</td>
                    <td class="strike-price">${option.strike}</td>
                    <td>${option.put.iv || '0.0%'}</td>
                    <td class="${option.put.changeOi >= 0 ? 'positive' : 'negative'}">${option.put.changeOi >= 0 ? '+' : ''}${option.put.changeOi || '0'}</td>
                    <td class="put-oi">${option.put.oi ? option.put.oi.toLocaleString() : '0'}</td>
                    <td>${option.put.price || '0.00'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Update Open Interest analysis
        function updateOIAnalysis(chainData) {
            // Calculate total OI and PCR
            let totalCallOI = 0;
            let totalPutOI = 0;
            
            chainData.forEach(option => {
                totalCallOI += option.call.oi || 0;
                totalPutOI += option.put.oi || 0;
            });
            
            const pcr = totalPutOI / totalCallOI;
            
            // Update UI
            document.getElementById('total-oi').textContent = (totalCallOI + totalPutOI).toLocaleString();
            document.getElementById('pcr-value').textContent = pcr.toFixed(2);
            
            // Find max pain (simplified)
            let maxPainStrike = 0;
            let minPain = Infinity;
            
            chainData.forEach(option => {
                const pain = Math.abs((option.call.oi || 0) - (option.put.oi || 0));
                if (pain < minPain) {
                    minPain = pain;
                    maxPainStrike = option.strike;
                }
            });
            
            document.getElementById('max-pain').textContent = maxPainStrike;
            
            // Update OI chart
            updateOIChart(chainData);
        }

        // Update Open Interest chart
        function updateOIChart(chainData) {
            const ctx = document.getElementById('oiChart').getContext('2d');
            
            // Destroy previous chart if it exists
            if (oiChart) {
                oiChart.destroy();
            }
            
            // Prepare data
            const strikes = chainData.map(option => option.strike);
            const callOI = chainData.map(option => option.call.oi || 0);
            const putOI = chainData.map(option => option.put.oi || 0);
            
            // Create new chart
            oiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: strikes,
                    datasets: [
                        {
                            label: 'Call OI',
                            data: callOI,
                            backgroundColor: '#2ecc71'
                        },
                        {
                            label: 'Put OI',
                            data: putOI,
                            backgroundColor: '#e74c3c'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Update Sudarshan Chakra visualization
        function updateSudarshanChakra(chainData) {
            // Calculate call/put percentages
            let totalCallOI = 0;
            let totalPutOI = 0;
            
            chainData.forEach(option => {
                totalCallOI += option.call.oi || 0;
                totalPutOI += option.put.oi || 0;
            });
            
            const totalOI = totalCallOI + totalPutOI;
            const callPercentage = Math.round((totalCallOI / totalOI) * 100);
            const putPercentage = 100 - callPercentage;
            
            // Update UI
            document.getElementById('call-percentage').textContent = callPercentage + '%';
            document.getElementById('put-percentage').textContent = putPercentage + '%';
            
            // Update chakra visualization
            const chakra = document.querySelector('.sudarshan-chakra');
            chakra.style.background = `conic-gradient(
                from 0deg,
                #2ecc71 0% ${callPercentage}%,
                #e74c3c ${callPercentage}% 100%
            )`;
        }

        // Generate AI analysis
        async function generateAIAnalysis() {
            try {
                document.getElementById('ai-analysis-text').textContent = "Analyzing market data...";
                
                // In a real implementation, you would fetch from your backend API
                // const response = await fetch('/api/ai-analysis');
                // const data = await response.json();
                
                // Simulate API response with mock data
                setTimeout(() => {
                    const analyses = [
                        "Market shows bullish sentiment with strong call buying at 25000. Resistance at 25200, support at 24800.",
                        "PCR indicates neutral to bearish sentiment. Consider writing calls at 25100 and buying puts at 24900 for hedge.",
                        "Volatility is elevated suggesting good premium selling opportunities. Iron condor between 24800 and 25200 recommended.",
                        "Strong put writing at 25000 indicates support level. Bull call spread with buys at 24900 and sells at 25200 could be profitable."
                    ];
                    
                    const outlooks = ["Bullish", "Bearish", "Neutral", "Volatile"];
                    
                    const randomAnalysis = analyses[Math.floor(Math.random() * analyses.length)];
                    const randomOutlook = outlooks[Math.floor(Math.random() * outlooks.length)];
                    
                    document.getElementById('ai-outlook').textContent = randomOutlook;
                    document.getElementById('ai-analysis-text').textContent = randomAnalysis;
                }, 2000);
            } catch (error) {
                console.error('Error generating AI analysis:', error);
                alert('Failed to generate AI analysis. Please try again.');
            }
        }

        // Load TradingView widget
        function loadTradingView() {
            const widgetDiv = document.querySelector('.tradingview-widget');
            widgetDiv.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <h4>TradingView Chart Loaded</h4>
                    <p>NIFTY 50 - Real-time Chart</p>
                    <div class="mt-3">
                        <small class="text-muted">In a real implementation, this would show the actual TradingView widget</small>
                    </div>
                </div>
            `;
            
            // In a real implementation, you would initialize the TradingView widget here
            // new TradingView.widget({...});
        }
    </script>
</body>
</html>
