<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Options Analysis Dashboard</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; background:#0d1117; color:#e6edf3; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial; }
  .wrap { max-width:1280px; margin:24px auto; padding:0 16px; }
  header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
  h1 { font-size:22px; margin:0; }
  .panel { background:#161b22; border:1px solid #30363d; border-radius:12px; padding:16px; }
  .grid { display:grid; grid-template-columns: 1fr 420px; gap:16px; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; }
  select, button {
    background:#0b1220; color:#e6edf3; border:1px solid #30363d; border-radius:8px; padding:8px 10px; font-size:14px;
  }
  button { background:#1f6feb; border-color:#1f6feb; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .tag { font-size:12px; opacity:.85; padding:2px 8px; background:#0b1220; border:1px solid #233; border-radius:999px; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  th, td { padding:8px 10px; border-bottom:1px solid #30363d; text-align:right; white-space:nowrap; }
  th { position:sticky; top:0; background:#0f1523; z-index:1; }
  td.strike, th.strike, th.left, td.left { text-align:left; }
  tr.atm { background:rgba(31,111,235,.15); }
  .muted { opacity:.7; }
  .kpi { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px; }
  .kpi .box { background:#0b1220; border:1px solid #233; border-radius:10px; padding:12px; }
  .kpi .val { font-size:18px; font-weight:700; }
  footer { margin-top:18px; display:flex; gap:10px; flex-wrap:wrap; }
  .warn { color: #ffd33d; }
  .ok { color:#3fb950; }
  .err { color:#f85149; }
  .tall { max-height:70vh; overflow:auto; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Options Analysis Dashboard</h1>
      <div class="controls">
        <select id="under">
          <!-- under_security_id|under_exchange_segment -->
          <option value="25|IDX_I">BANKNIFTY (ID)</option>
          <option value="2|IDX_I">NIFTY (ID)</option>
        </select>
        <select id="expiry"><option>Loading…</option></select>
        <button id="refresh">Refresh</button>
        <span id="status" class="tag muted">idle</span>
      </div>
    </header>

    <div class="grid">
      <div class="panel tall">
        <div class="muted" id="metaTop">—</div>
        <table id="chain">
          <thead>
            <tr>
              <th class="left">CE LTP</th>
              <th>CE IV</th>
              <th>CE OI</th>
              <th>Δ OI</th>
              <th class="strike">STRIKE</th>
              <th>Δ OI</th>
              <th>PE OI</th>
              <th>PE IV</th>
              <th>PE LTP</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px 0;">Open Interest (summary)</h3>
        <div class="kpi">
          <div class="box">
            <div class="muted">Total CE OI</div>
            <div class="val" id="k_ceoi">—</div>
          </div>
          <div class="box">
            <div class="muted">Total PE OI</div>
            <div class="val" id="k_peoi">—</div>
          </div>
          <div class="box">
            <div class="muted">PCR</div>
            <div class="val" id="k_pcr">—</div>
          </div>
          <div class="box">
            <div class="muted">Max Pain*</div>
            <div class="val" id="k_maxpain">—</div>
          </div>
        </div>
        <footer class="muted">
          <div>ATM row is highlighted.</div>
          <div><span class="warn">PCR &amp; Max-Pain are quick approximations</span> for feel.</div>
          <div id="meta" class="muted"></div>
        </footer>
      </div>
    </div>
  </div>

<script>
const el = (id) => document.getElementById(id);
const fmt = (n) => Number(n||0).toLocaleString('en-IN');

const state = {
  underId: 25, seg: 'IDX_I', expiry: null, spot: 0
};

function setStatus(msg, cls='muted') {
  const s = el('status');
  s.className = 'tag ' + cls;
  s.textContent = msg;
}

function parseUnder(val) {
  const [id, seg] = val.split('|');
  state.underId = Number(id);
  state.seg = seg;
}

async function loadExpiries() {
  setStatus('loading expiries…');
  const r = await fetch(`/optionchain/expirylist?under_security_id=${state.underId}&under_exchange_segment=${state.seg}`);
  const j = await r.json();
  if (j.status !== 'success') throw new Error('expiry list failed');
  const list = j.data || [];
  const ex = el('expiry');
  ex.innerHTML = '';
  list.forEach((d, i) => {
    const o = document.createElement('option');
    o.value = d; o.textContent = d;
    if (i===0) o.selected = true;
    ex.appendChild(o);
  });
  state.expiry = ex.value;
  setStatus(`expiries: ${list.length}`, 'ok');
}

async function loadChain() {
  setStatus('loading chain…');
  const url = `/optionchain?under_security_id=${state.underId}&under_exchange_segment=${state.seg}&expiry=${encodeURIComponent(state.expiry)}&show_all=true`;
  const r = await fetch(url);
  const j = await r.json();

  if (j.status !== 'success') throw new Error('chain failed');
  const body = el('chain').querySelector('tbody');
  body.innerHTML = '';

  state.spot = Number(j.spot || 0);
  const chain = j.chain || [];
  const closest = chain.reduce((best, row) => {
    const d = Math.abs((row.strike||0) - state.spot);
    return d < best.d ? {d, s: row.strike} : best;
  }, {d: 1e18, s: 0}).s;

  chain.forEach(row => {
    const tr = document.createElement('tr');
    if (Math.abs((row.strike||0) - closest) < 1e-9) tr.classList.add('atm');

    const c = row.call || {}, p = row.put || {};
    tr.innerHTML = `
      <td class="left">${(c.price||0).toFixed(2)}</td>
      <td>${(c.iv||0).toFixed(2)}%</td>
      <td>${fmt(c.oi)}</td>
      <td>${fmt(c.chgOi)}</td>
      <td class="strike">${fmt(row.strike)}</td>
      <td>${fmt(p.chgOi)}</td>
      <td>${fmt(p.oi)}</td>
      <td>${(p.iv||0).toFixed(2)}%</td>
      <td>${(p.price||0).toFixed(2)}</td>
    `;
    body.appendChild(tr);
  });

  // KPIs
  el('k_ceoi').textContent   = fmt(j.summary?.total_call_oi || 0);
  el('k_peoi').textContent   = fmt(j.summary?.total_put_oi  || 0);
  el('k_pcr').textContent    = (j.summary?.pcr ?? 0).toFixed(2);
  el('k_maxpain').textContent= fmt(j.summary?.max_pain || 0);

  // meta
  el('metaTop').textContent = `Expiry: ${j.expiry || '-'} · LTP: ${state.spot ? state.spot.toFixed(2) : '-'}`;
  el('meta').textContent = `Rows: ${j.meta?.count_full || 0} · Window: ${j.meta?.show_all ? 'Full' : j.meta?.window || '-'}`;

  setStatus('ok', 'ok');
}

async function init() {
  parseUnder(el('under').value);
  await loadExpiries();
  await loadChain();
}

el('under').addEventListener('change', async (e) => {
  parseUnder(e.target.value);
  await loadExpiries();
  await loadChain();
});

el('expiry').addEventListener('change', async (e) => {
  state.expiry = e.target.value;
  await loadChain();
});

el('refresh').addEventListener('click', async () => {
  await loadChain();
});

init().catch(err => {
  console.error(err);
  setStatus('error', 'err');
  alert('Failed: ' + err);
});
</script>
</body>
</html>
